[Unit]
Description=OpenZiti Controller
After=network-online.target

[Service]
Type=simple

# manage the user and permissions for the service automatically
DynamicUser=yes

# this env file configures the service, including whether or not to perform bootstrapping
EnvironmentFile=/opt/openziti/etc/controller/service.env

# relative to /var/lib
StateDirectory=ziti-controller
WorkingDirectory=/var/lib/ziti-controller

# mount the contents of the openziti-console package, if installed, and publish on mgmt API at /zac
ReadOnlyPaths=/opt/openziti/share/console

# share files like agent.sock, the cluster agent IPC socket
ReadWritePaths=/opt/openziti/share/controller

# remove stale agent socket file if it exists
ExecStartPre=-/bin/rm -f /opt/openziti/share/controller/agent.sock

# check config.yml for validity before starting
ExecStartPre=/opt/openziti/etc/controller/entrypoint.bash check config.yml

# run the controller
ExecStart=/opt/openziti/bin/ziti controller run config.yml --cli-agent-addr=unix:/opt/openziti/share/controller/agent.sock ${ZITI_ARGS}

Restart=always
RestartSec=3

LimitNOFILE=65535
UMask=0007

# allow binding low ports, e.g., 443/tcp; NOTE: use TLS passthrough if fronting with a reverse proxy, i.e., "raw" TCP
# proxy
# AmbientCapabilities=CAP_NET_BIND_SERVICE

[Install]
WantedBy=multi-user.target
